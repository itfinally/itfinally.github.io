##### 标签: 状态机, 解耦设计



To B 业务的变化较为频繁, 重可靠性与扩展性, 轻性能, 目前过去在支付相关共有五个系统, 需要整合起来明确职责.

业务目标:

- 对用户可靠便捷的支付, 如业务流程异步化, 合理的重试
- 可追踪, 易扩展的交易流程, 需要引入状态机, 同时要做好幂等处理
- 简化业务的逻辑实现, 将过去的流程重新抽象并使用状态机进行管理



由于支付本身的业务已拆分, 订单支付系统本身只负责订单与支付的关联与管理, 在该项目引入状态机主要是为后续订单系统重构做实验.

Spring 也有状态机, 但似乎过于重量级, 搜索后发现一款比较符合实际情况的状态机, 项目为 squirrel-foundation.



关于 squirrel-foundation  相关资料:

- [squirrel 项目地址](https://github.com/hekailiang/squirrel)
- [squirrel-foundation 状态机入门文档](https://my.oschina.net/u/3864078/blog/3006696)
- [squirrel 使用](https://www.yangguo.info/2015/02/01/squirrel/)
- [squirrel-foundation 状态机的使用细节](https://segmentfault.com/a/1190000009906469)



订单支付系统主要实现订单与支付的隔离与对接, 重新针对订单与支付本身的职责进行界定.

支付本身需要财务进行审核, 因此支付必定是请求同步, 流程异步. <strong>下图为支付申请的流程</strong>.

```sequence
participant 用户
participant 订单支付系统

用户->订单支付系统: 提交支付申请单
订单支付系统->订单支付系统: 持久化支付申请
订单支付系统->订单支付系统: 通知其他本地服务开始处理申请( 异步 )
订单支付系统->用户: 响应支付申请请求, 统一返回处理中
```



由于收款本身也是支付( 相对用户而言 ), 因此收款行为也会集成到该系统内, 但是此时提交的应为支付单而非支付申请单, 同样地, 也是需要走一样的流程, 对整个交易业务进行异步处理, 主要是方便用户使用, 

同时也便于系统内部实现重试机制, 异步化还能带来吞吐量的提升.



